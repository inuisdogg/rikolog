Riko-Log (離婚ログ) プロジェクト仕様書

## 開発・動作確認（復旧用メモ）

### 起動

```bash
cd /Users/inu/Desktop/Riko-Log
npm run dev
```

- デフォルトは **`127.0.0.1`（ローカルのみ）**で起動する想定です。
- 同一Wi‑Fi等でスマホから確認したい場合は、明示的にホスト公開します：

```bash
npm run dev:host
```

### よくあるトラブル

- **`Error: listen EPERM: operation not permitted ...` で dev server が起動しない**
  - これは **コードの壊れではなく、実行環境側が待ち受けを許可していない**時に出ます（セキュリティ/サンドボックス/管理ポリシー等）。
  - 対処:
    - まずポート変更で回避できるか確認: `npm run dev -- --port 5174`
    - それでもダメなら、端末/実行環境の制限（会社PCのポリシー、セキュリティソフト、アプリのサンドボックス等）を確認してください。

- **白画面になった / データが壊れた気がする**
  - localStorage の JSON が中途半端に壊れると、`JSON.parse` 例外で落ちることがあります。
  - 現在は `riko_user` / `riko_logs` を読み込む際に **部分復旧→復旧不能なら退避して初期化**する実装を入れています。
    - 退避キー: `riko_user_corrupt_backup` / `riko_logs_corrupt_backup`
  - それでも挙動がおかしい場合:
    - アプリ内の **Help →「キャッシュをリセットして再読み込み」** を実行
    - もしくはブラウザのサイトデータ（Storage）を削除

1. プロジェクト概要

「事実を記録し、あなたを守る盾になる」
離婚を検討・準備しているユーザー（主にモラハラ、DV、不貞被害者）が、安全かつ法的に有効な証拠を記録・管理するためのWebアプリケーション。
感情的な「日記」ではなく、裁判資料として使える「事実記録」に特化している。

2. コアコンセプト & UX要件

カモフラージュ:

アプリアイコンや起動直後の画面は「電卓」に偽装する。

特定の計算式（パスコード 7777 + =）を入力した時のみ、本アプリが解除される。

緊急時は「緊急ロック」ボタンで即座に電卓に戻る。

客観的記録:

「辛い」「悲しい」といった感情よりも、「いつ・どこで・誰が・何をした」という5W1Hの事実記録を優先する。

GPS位置情報、日時を自動取得し、改ざん不可能なログを目指す。

安全基地 (Safety Base):

緊急時に警察や相談機関へすぐに繋がれる動線を確保する。

3. 主要機能一覧

A. カモフラージュ・認証

CalculatorMode: 見た目は普通の電卓。計算機能も動作する。解除コード入力でログイン画面へ遷移。

AuthScreen: ログイン/新規登録。Face ID（生体認証）風のログインUI。

B. ダッシュボード (Home)

進捗管理: 記録開始からの経過日数、最終更新日を表示。

記録充実度: ログの数やメディア（写真・録音）の有無から「証拠レベル（％）」を算出し、バーで表示。

統計: カテゴリ別（モラハラ、不貞など）の件数内訳。

アドバイス: 充実度に応じて、事務的かつ客観的なネクストアクション（弁護士相談など）を提案。

C. 証拠ログ (Timeline / Add)

タイムライン: 記録したログを時系列でカード表示。

新規記録:

カテゴリ選択（モラハラ、DV、不貞など）

位置情報取得（MapPin）

詳細テキスト入力

証拠添付UI（写真、録音、動画のダミーUI）

D. 提出用出力 (Export)

PDFプレビュー: 裁判所の「陳述書」フォーマットに整形されたプレビューを表示。

透かし: 正式版ではないことを示す透かし表示。

E. 安全基地 (Safety / Help)

緊急連絡先: 110番、#8008（DV相談）、#9110への発信ボタン。

お役立ちリンク: 法テラス、内閣府DV相談などへのリンク。

避難のヒント: 逃げる時の持ち物リストなどの静的情報。

F. メッセージ (Message)

運営からの事務的な通知を表示する受信トレイ。

4. 技術スタック・デザイン

Framework: React

Styling: Tailwind CSS

配色は Slate (グレー・黒) をベースに、アクセントで Pink (ブランドカラー) を使用。

全体的に「事務的」「堅牢」「冷静」なトーン＆マナー。

Icons: Lucide React

5. データ構造 (想定)

User: { id, email, registeredAt, reason, targetDate }

Log: { id, date, time, category, location, content, attachments: [{type, name}] }

※現在は localStorage を使用してブラウザ内にデータを永続化している。

6. 今後の開発ロードマップ

Supabase連携: 認証とPostgreSQLへのデータ保存の実装。 ✅ **実装中**

メディアアップロード: 実際に画像や音声をSupabase Storageへ保存する機能。

PDF生成: jspdf 等を用いて実際にPDFファイルをダウンロード可能にする。

PWA化: ホーム画面に追加してネイティブアプリのように振る舞わせる設定。

---

## 7. Supabaseデータベースのセットアップ

実用に耐えるデータベースとして、Supabase（PostgreSQL）への移行を進めています。

### 必要な準備

1. **Supabaseプロジェクトの作成**
   - [Supabase Dashboard](https://app.supabase.com/)でプロジェクトを作成
   - 詳細は `SETUP_SUPABASE.md` を参照

2. **環境変数の設定**
   - プロジェクトルートに `.env` ファイルを作成
   - Supabase設定値を記入（`SETUP_SUPABASE.md`を参照）

3. **パッケージのインストール**
   ```bash
   npm install
   ```

4. **データベース設計の確認**
   - `DATABASE_DESIGN.md` でデータ構造を確認

### 実装状況

- ✅ データベース設計書の作成（PostgreSQLテーブル設計）
- ✅ Supabase設定ファイル (`supabase.config.js`)
- ✅ データアクセス層の実装 (`db/` ディレクトリ)
  - ✅ ユーザー情報 (`db/users.js`)
  - ✅ ログ (`db/logs.js`)
  - ✅ プレミアム情報 (`db/premium.js`)
  - ✅ 掲示板 (`db/board.js`)
  - ✅ メッセージ (`db/messages.js`)
- ⏳ アプリケーションコードとの統合（次のステップ）

### 次のステップ

1. Supabaseプロジェクトのセットアップ（`SETUP_SUPABASE.md`を参照）
2. SQLの実行（テーブル作成）
3. 環境変数の設定
4. App.jsxのlocalStorage呼び出しをSupabase呼び出しに置き換え
5. 認証フローの実装